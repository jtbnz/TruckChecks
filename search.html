<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Search for Truck Items</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
            padding: 20px;
        }
        
        .station-info {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 30px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .station-name {
            font-size: 18px;
            font-weight: bold;
            color: #12044C;
        }
        
        .station-selection {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            background-color: #f9f9f9;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .station-dropdown {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .select-station-btn {
            width: 100%;
            padding: 15px;
            background-color: #12044C;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .select-station-btn:hover {
            background-color: #0056b3;
        }
        
        button {
            padding: 15px 30px;
            font-size: 20px;
            cursor: pointer;
            margin-bottom: 20px;
            background-color: #12044C;
            color: white;
            border: none;
            border-radius: 5px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        #results {
            margin-top: 20px;
            font-size: 18px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            text-align: left;
        }
        
        .back-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .back-button:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

<div id="station-selection" style="display: none;">
    <div class="station-selection">
        <h2>Select Station for Voice Search</h2>
        <p>Please select a station to search within:</p>
        
        <select id="station-dropdown" class="station-dropdown">
            <option value="">-- Select a Station --</option>
        </select>
        
        <button onclick="selectStation()" class="select-station-btn">Continue to Voice Search</button>
        
        <div style="margin-top: 30px;">
            <a href="index.php" class="back-button">← Back to Home</a>
        </div>
    </div>
</div>

<div id="search-interface" style="display: none;">
    <div id="station-info" class="station-info" style="display: none;">
        <div class="station-name" id="current-station-name"></div>
        <div id="current-station-description" style="color: #666; margin-top: 5px;"></div>
        <div style="margin-top: 10px;">
            <a href="#" onclick="changeStation()" style="color: #12044C; text-decoration: none; font-size: 14px;">
                Change Station
            </a>
        </div>
    </div>

    <h1>Voice Search for Truck Items</h1>
    <button onclick="startRecognition()">Press and Speak</button>
    <div id="results"></div>
    
    <div style="margin-top: 30px;">
        <a href="index.php" class="back-button">← Back to Home</a>
    </div>
</div>

<script>
let stations = [];
let currentStation = null;

// Load stations and check current station on page load
window.onload = function() {
    loadStations();
};

function loadStations() {
    fetch('get_stations.php')
        .then(response => response.json())
        .then(data => {
            stations = data.stations;
            currentStation = data.currentStation;
            
            if (stations.length === 0) {
                // No stations configured, show search interface directly
                document.getElementById('search-interface').style.display = 'block';
            } else if (stations.length === 1) {
                // Only one station, auto-select it
                currentStation = stations[0];
                setCurrentStation(currentStation);
                document.getElementById('search-interface').style.display = 'block';
                updateStationInfo();
            } else if (currentStation) {
                // Station already selected
                document.getElementById('search-interface').style.display = 'block';
                updateStationInfo();
            } else {
                // Multiple stations, need to select one
                populateStationDropdown();
                document.getElementById('station-selection').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading stations:', error);
            // Fallback to showing search interface
            document.getElementById('search-interface').style.display = 'block';
        });
}

function populateStationDropdown() {
    const dropdown = document.getElementById('station-dropdown');
    dropdown.innerHTML = '<option value="">-- Select a Station --</option>';
    
    stations.forEach(station => {
        const option = document.createElement('option');
        option.value = station.id;
        option.textContent = station.name;
        dropdown.appendChild(option);
    });
}

function selectStation() {
    const dropdown = document.getElementById('station-dropdown');
    const stationId = dropdown.value;
    
    if (!stationId) {
        alert('Please select a station');
        return;
    }
    
    const station = stations.find(s => s.id == stationId);
    if (station) {
        setCurrentStation(station);
        document.getElementById('station-selection').style.display = 'none';
        document.getElementById('search-interface').style.display = 'block';
        updateStationInfo();
    }
}

function setCurrentStation(station) {
    currentStation = station;
    
    // Set cookie for persistence
    document.cookie = `preferred_station=${station.id}; expires=${new Date(Date.now() + 365*24*60*60*1000).toUTCString()}; path=/`;
    
    // Set session storage
    if (typeof(Storage) !== "undefined") {
        sessionStorage.setItem('current_station_id', station.id);
    }
}

function updateStationInfo() {
    if (currentStation) {
        document.getElementById('current-station-name').textContent = currentStation.name;
        document.getElementById('current-station-description').textContent = currentStation.description || '';
        document.getElementById('station-info').style.display = 'block';
    }
}

function changeStation() {
    // Clear station preference
    document.cookie = 'preferred_station=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
    
    if (typeof(Storage) !== "undefined") {
        sessionStorage.removeItem('current_station_id');
    }
    
    currentStation = null;
    document.getElementById('search-interface').style.display = 'none';
    
    if (stations.length > 1) {
        populateStationDropdown();
        document.getElementById('station-selection').style.display = 'block';
    } else {
        loadStations(); // Reload to check current state
    }
}

function startRecognition() {
    // Initialize the SpeechRecognition object
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.interimResults = false; // Only final results, no interim results
    recognition.maxAlternatives = 1; // We're only interested in the top result

    recognition.start(); // Start listening

    recognition.onresult = function(event) {
        const item = event.results[0][0].transcript; // Capture the recognized text
        document.getElementById('results').innerHTML = `Searching for: ${item}`;
        searchItem(item);
    };

    recognition.onspeechend = function() {
        recognition.stop(); // Stop listening when user stops speaking
    };

    recognition.onerror = function(event) {
        document.getElementById('results').innerHTML = `Error: ${event.error}`;
        recognition.stop(); // Ensure we stop listening on error
    };
}

function searchItem(item) {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', 'search_item.php', true);
    xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        if (xhr.status === 200) {
            document.getElementById('results').innerHTML = xhr.responseText;
        }
    };
    xhr.send(`item=${encodeURIComponent(item)}`);
}
</script>

</body>
</html>
